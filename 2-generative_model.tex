Light sources in the sky radiate photons. A telescope image records the number of photons that arrive at each pixel. Often, telescope images consists of multiple filter bands, each absorbing photons within a specified wavelength. 

For a given $H \times W$ pixel image with $B$ filter bands, our goal is to infer a catalog of 
stars. 
The catalog first specifies the number of stars 
in the image. Then for each star, the catalog 
records its location and its flux, or brightness,
in each band. 
The space of latent variables 
$\mathcal{Z}$ is the collection of all possible catalogs of the form
\begin{align}
    z := \{N, (\ell_i, f_{i,1}, ..., f_{i,B})_{i = 1}^N\},
    \label{eq:cat_formulation}
\end{align}
where the number of stars in the catalog
is $N\in\mathbb{N}$;
% \jeff{Unfortunately I don't think astronomers define catalog this way. They think of a catalog as including uncertainty estimates, not as a realization of some random variables.}
% \bryan{I think this is actually how Portillos refers to a catalog -- he does admit that this isn't 
% what astronomers traditionally think of a catalog. The reason we need this is because our posterior is really defined over the space of all possible catalogs -- each sample from the posterior is a catalog as defined in \eqref{eq:cat_formulation}. I'll try to set this up more explicitly in the introduction. }
% \jeff{Sounds good. I really like defining a catalog as a sample, not a distribution. If Portillos defines it this way too, perhaps we can make the new definition stick.}
the location of the $i$th star is $\ell_i \in \Reals^2$;
the flux of the $i$th star in the $b$th band is $f_{i, b}\in\Reals^+$. 

The prior is a distribution over the set of catalogs $\mathcal{Z}$. In this work, we use a marked spatial Poisson process. That is, we first draw the number of stars contained in the $H\times W$ image:
\begin{align}
	N &\sim \text{Poisson}(\mu HW).
\end{align}
% \jeff{Better to talk about the marked point process later (or earlier, in the introduction). Just describe the model as simply as possible here.}
Next, we draw locations
\begin{align}
  \ell_1, ..., \ell_N | N &\stackrel{iid}{\sim} \text{Uniform}([0, H] \times [0, W]). 
 \end{align}
We draw fluxes in the first band from a power law distribution:
\begin{align}
    f_{1, 1}, ..., f_{N,1} | N & 
    \stackrel{iid}{\sim} \text{Pareto}(f_{min}, \alpha) 
    \label{eq:flux_prior}.
\end{align}
Fluxes in the other bands are defined in terms of ``colors." The colors are drawn,
\begin{align}
  c_{1, b}, ..., c_{N,b} | N  & 
      \stackrel{iid}{\sim} \mathcal{N}(\mu_c, \sigma^2_c) \quad \forall b = 2, ..., B.
\end{align}
Given flux in the first band band $f_{i,1}$ and color $c_{i,b}$,
the flux in the $b$th band is  $f_{i,b} = f_{i,1} \times 10^{c_{i,b} / 2.5}$.
\jeff{Is the reference band always 1? I usually think of the r band as having index 3. What does Portillo do?}
\bryan{I didn't actually mean the index of the band in the telescope -- just wanted an enumerate of bands $1, ..., B$}
% the flux in the $b$th band $f_{i,b}$ is $f_{i,1} \times 10^{c_{i,b} / 2.5}$.
% \jeff{$f^b$ looks like a value raised to an exponent. $f^{(b)}$ instead?}

% We call the first band a ``reference band'' and define colors with respect to the band. 
% An image with $B$ bands, has $B - 1$ colors.
% The relation between flux in the $b$th band $f_b$ and color $c_{i, b}$ is 
% $c_{i,b} = 2.5\log_10(f_{i,b}/f_{i,1})$

% In our formulation, each value of $N$ corresponds to a disjoint set of $N$ locations and fluxes.
% Let $\ell$ and $f$ (without subscripts) each denote the triangular array of latent variables.

% Having drawn $N$, we index into the $N$th row of triangular array, and use this set of locations and fluxes to construct 
% the image. The expected number of photoelectrons measured at pixel $(h,w)$ in band $b$ is

Having drawn a catalog $z = \{N, (\ell_i, f_{i,1}, ..., f_{i,B})_{i = 1}^N\}$,
the expected number of photoelectrons measured at pixel $(h,w)$ in band $b$ is
\begin{align}
  \lambda^b_{hw} = I^{b}_{hw} + \sum_{i = 1}^N f_{i,b} \mathcal{P}^b\big(h - \ell_{i}[1], w - \ell_{i}[2]\big),
  \label{eq:expected_intensity}
\end{align}
where $I^{b}_{hw}$ is the background intensity, which we allow to vary by pixel and band. $\mathcal{P}^b$ is the point spread function (PSF) for band $b$. The PSF
is a function 
\begin{align}
\mathcal{P}^b : \Reals \times \Reals \mapsto \Reals^+,
\end{align}
describing how a stellar point source appears
on our image. We model the PSF as a weighted average between a Gaussian ``core" and a power-law ``wing" as described in~\cite{Xin2018psf}. For each band, the PSF has the form
\begin{align}
    \mathcal{P}(u,w) = \frac{\exp(\frac{-r^2}{2\sigma_1^2}) + 
                            b \exp(\frac{-r^2}{2\sigma_2^2}) + 
                            p_0(1 + \frac{r^2}{\gamma\sigma^2_P})^{-\gamma/2} }{1 + b + p_0},
\end{align}
where $r^2 = u^2 + w^2$. The PSF parameters vary by band. Define 
$\pi := (\sigma_{1}^{(b)}, \sigma_{2}^{(b)}, \sigma_{P}^{(b)}, \gamma^{(b)}, p_{0}^{(b)})_{b=1}^B$ as the collection of PSF parameters across all bands. 

The background intensity is modeled with an affine function: 
\begin{align}
    I_{ij}^{b} = \beta_0^{b} + \beta_1^{b} \times i + \beta_2^{b} \times j.
\end{align}
The background parameters are specific to the band. 

The model parameters $\pi$ for the PSF and $\beta$ are estimated by the SDSS software pipeline and reported along with the release of each SDSS image. Alternatively, in Section~\ref{sec:model_params}, we propose a method to estimate these parameters jointly with the catalog. 

Finally, we model the observed number of photoelectrons at pixel $(h,w)$ and band $b$ as Gaussian
with mean and variance equal to $\lambda^b_{hw}$. 
% This model is reasonable due to the law of rare events and the Gaussian approximation to the Poisson.
% \jeff{If we're actually using a Gaussian rather than a Poisson, it's probably better not to mention the Poisson.
% Just say we model the number as Gaussian with var == mean.}
Thus, the observed pixel intensities are
\begin{align}
  x_{hw}^b | z \overset{ind}{\sim} \mathcal{N}(\lambda^b_{hw}, \lambda^b_{hw})
  \quad\forall b = 1, ..., B; h = 1,..., H; w = 1, ..., W. 
\end{align}
The scaling of variance with the expected intensity is reasonable due to the Poissonian nature of photon arrivals. 
% \jeff{Better to use lowercase $x$ rather than $X$ if you're not going to use uppercase for all the random variables}
Explicitly, the log-likelihood is
\begin{align}
    \log p(x | z) &= \sum_{b = 1}^{B} \sum_{h = 1}^H \sum_{w = 1}^W 
        \Big\{\frac{1}{2\lambda^b_{hw}}(x_{hw}^b  - \lambda^b_{hw})^2 - 
               \frac{1}{2}\log(2\pi\lambda^b_{hw})\Big\}
    \label{eq:loglik}.
\end{align}

The likelihood and priors described above are similar to those
presented in~\cite{Portillo_2017, Feder_2019}. We set $\alpha = 2$; we set 
$f_{min}$ to correspond with the SDSS 
lower detection limit ($\approx$ 22 magnitude); we use a standard Gaussian for color priors. 

One difference is that \cite{Portillo_2017, Feder_2019} use an exponential prior on $N$. We use a Poisson prior and set $\mu = 0.15$, slightly denser than the $0.1$ stars per pixel 
brighter than 22mag found in the Hubble catalog of M2. 

In summary, we have detailed the likelihood
$p(x | z)$ which describes the generation of an image $x$ given a catalog $z$. We have specified a prior distribution $p(z)$ over the space 
of all catalogs $\mathcal{Z}$. 
Our goal is to answer the question, ``given observed image $x$, which 
catalogs best explain the data?"
The question is answered by the posterior distribution $p(z | x)$. While 
the exact posterior distribution is intractable, we detail our variational approximation in the next section. 